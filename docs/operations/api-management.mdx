---
title: API Management
description: Configure API gateway, routing, and API management features in OpenChoreo.
sidebar_position: 6
---

import CodeBlock from "@theme/CodeBlock";
import { versions } from "../_constants.mdx";

# API Management

OpenChoreo provides comprehensive API Management capabilities through its API Platform module. This guide walks you through enabling API Management, securing your APIs with OAuth2, and managing API access control for your components.

## Overview

The API Management module in OpenChoreo provides:

- **OAuth2 Authentication**: Secure your APIs with industry-standard OAuth2 authentication
- **Token Validation**: Automatic JWT token validation for protected endpoints
- **Rate Limiting**: Control API usage with customizable rate limits
- **API Discovery**: Centralized API catalog for all your services
- **Thunder IDP Integration**: Built-in identity provider for testing and development

## Prerequisites

Before you begin, ensure you have:

- **OpenChoreo installed** in your Kubernetes cluster
- **kubectl** configured to access your cluster
- **Helm 3.12+** installed
- **curl** or similar tool for testing API endpoints

## Installation

The API Platform module is **disabled by default**. You need to explicitly enable it during OpenChoreo installation or upgrade.

### Enable During Initial Installation

When installing OpenChoreo Dataplane, enable the API Platform module using the `--set` flag:

<CodeBlock language="bash">
{`helm upgrade --install openchoreo-data-plane oci://ghcr.io/openchoreo/helm-charts/openchoreo-data-plane \\
    --version 0.0.0-latest-dev \\
    --namespace openchoreo-data-plane \\
    --create-namespace \\
    --set gateway.httpPort=19080 \\
    --set gateway.httpsPort=19443 \\
    --set external-secrets.enabled=true \\
    --set gateway.envoy.mountTmpVolume=true \\
    --set api-platform.enabled=true`}

</CodeBlock>

### Enable in Existing Installation

If OpenChoreo is already installed, first install the API Platform CRDs:

```bash
kubectl apply --server-side \
    -f https://raw.githubusercontent.com/wso2/api-platform/gateway-operator-v0.1.0/kubernetes/helm/operator-helm-chart/crds/api.api-platform.wso2.com_apiconfigurations.yaml \
    -f https://raw.githubusercontent.com/wso2/api-platform/gateway-operator-v0.1.0/kubernetes/helm/operator-helm-chart/crds/api.api-platform.wso2.com_gatewayconfigurations.yaml
```

Then upgrade the OpenChoreo Data plane to enable API Management:

<CodeBlock language="bash">
  {`helm upgrade --install openchoreo-data-plane oci://ghcr.io/openchoreo/helm-charts/openchoreo-data-plane \\
    --version 0.0.0-latest-dev \\
    --namespace openchoreo-data-plane \\
    --create-namespace \\
    --set gateway.httpPort=19080 \\
    --set gateway.httpsPort=19443 \\
    --set external-secrets.enabled=true \\
    --set gateway.envoy.mountTmpVolume=true \\
    --set api-platform.enabled=true`}
</CodeBlock>

## Verify Installation

After enabling the API Platform, verify that all components are running:

```bash
# Check API Platform pods
kubectl get pods -n openchoreo-data-plane --selector="app.kubernetes.io/instance=api-platform-default-gateway"
```

You should see pods similar to:

```
NAME                                                          READY   STATUS    RESTARTS   AGE
api-platform-default-gateway-controller-6d574f8478-skd8n      1/1     Running   0          17m
api-platform-default-gateway-policy-engine-6ccc5f76b4-m87f7   1/1     Running   0          17m
api-platform-default-gateway-router-55cd96cfc9-njf56          1/1     Running   0          17m
```

## Deploy a Sample Service

Let's deploy the Go Greeter Service to demonstrate API Management capabilities. If you've already deployed this service from the [Deploy Your First Component](../getting-started/deploy-first-component.mdx) guide, you can skip this step.

<CodeBlock language="bash">
  {`kubectl apply -f https://raw.githubusercontent.com/openchoreo/openchoreo/${versions.githubRef}/samples/from-image/go-greeter-service/greeter-service.yaml`}
</CodeBlock>

Wait for the deployment to complete:

```bash
kubectl get releasebinding greeter-service-development
```

Test that the service is accessible:

```bash
curl http://development.openchoreoapis.localhost:19080/greeter-service/greeter/greet\?name\=OpenChoreo
```

You should receive:

```text
Hello, OpenChoreo!
```

## Enable API Management for Your Component

To secure your component with API Management, you need to add an API Management trait. This can be done in two ways:

### Option 1: Update Component Custom Resource

Add the API Management trait configuration to your Component resource by applying it directly:

```bash
kubectl apply -f - <<EOF
apiVersion: openchoreo.dev/v1alpha1
kind: Component
metadata:
  name: greeter-service
  namespace: default
spec:
  autoDeploy: true
  componentType: deployment/service
  owner:
    projectName: default
  parameters:
    exposed: true
    port: 9090
    replicas: 1
    resources:
      limits:
        cpu: 500m
        memory: 512Mi
      requests:
        cpu: 100m
        memory: 256Mi
  traits:
    - instanceName: greeter-api
      name: api-configuration
      parameters:
        apiName: greeter-api
        apiVersion: v1.0
        context: /greeter-api/v1.0
        policies:
          - name: JwtAuthentication
            version: v0.1.0
        upstreamPort: 80
EOF
```

### Option 2: Using the OpenChoreo UI (Backstage)

If you have the Backstage UI installed:

1. Navigate to your component in the Backstage UI
2. Go to the **Traits** tab in the top menu
3. Click **Add Trait**
4. Select **api-configuration** from the available traits
5. Configure the trait parameters:

| Parameter      | Value               |
| -------------- | ------------------- |
| Instance Name  | `greeter-api`       |
| API Name       | `greeter-api`       |
| API Version    | `v1.0`              |
| Context        | `/greeter-api/v1.0` |
| Policy Name    | `JwtAuthentication` |
| Policy Version | `v0.1.0`            |
| Upstream Port  | `80`                |

6. Click **Add Trait** and **Save Changes** to apply changes to your component.

## Wait for Configuration to Apply

Monitor the component to ensure the API Management trait is applied:

```bash
kubectl get component/greeter-service -o yaml
```

Wait for the release to be updated:

```bash
kubectl get releasebinding greeter-service-development -o yaml
```

## Obtain an Access Token

OpenChoreo Control Plane uses WSO2 Thunder IDP for System Authentication. For testing purposes, OpenChoreo automatically creates an OAuth Application.
Let's obtain an access token using the test OAuth Application.

Please use the following test credentials to get a token:

- **Client ID**: `customer-portal-client`
- **Client Secret**: `supersecret`

### Request an Access Token

Use the OAuth2 client credentials flow to obtain a token:

```bash
curl -k -X POST https://thunder.openchoreo.localhost:8443/oauth2/token \
  -d 'grant_type=client_credentials' \
  -d 'client_id=customer-portal-client' \
  -d 'client_secret=supersecret'
```

You should receive a response similar to:

```json
{
  "access_token": "eyJhbGciOiJSUzI1NiIsImtpZCI6Ik11WGVKS...",
  "token_type": "Bearer",
  "expires_in": 3600
}
```

Save the access token for testing:

```bash
export ACCESS_TOKEN="eyJhbGciOiJSUzI1NiIsImtpZCI6Ik11WGVKS..."
```

## Test API Authentication

Now let's verify that API Management is working correctly.

### Test Without Token (Should Fail)

Try accessing the API without authentication:

```bash
curl -i http://development.openchoreoapis.localhost:19080/greeter-service/greeter/greet
```

You should receive a **401 Unauthorized** response:

```
HTTP/1.1 401 Unauthorized
content-type: application/json
content-length: 59
date: Mon, 22 Dec 2025 16:28:58 GMT
server: envoy
x-envoy-upstream-service-time: 20

{"error":"Unauthorized","message":"Authentication failed."}
```

This confirms that API Management is protecting your endpoint.

### Test With Token (Should Succeed)

Now test with the access token:

```bash
curl http://development.openchoreoapis.localhost:19080/greeter-service/greeter/greet\?name\=OpenChoreo \
  -H "Authorization: Bearer $ACCESS_TOKEN"
```

You should receive a **200 OK** response:

```
HTTP/1.1 200 OK
date: Mon, 22 Dec 2025 16:32:11 GMT
content-length: 19
content-type: text/plain; charset=utf-8
x-envoy-upstream-service-time: 18
server: envoy

Hello, OpenChoreo!
```

## API Management Configuration Options

The API Management trait supports various configuration options:

### Authentication

```yaml
authentication:
  type: oauth2 # Currently supports: oauth2, jwt, apikey
  oauth2:
    required: true
    scopes:
      - read:greetings
      - write:greetings
```

### Rate Limiting

```yaml
rateLimit:
  requestsPerUnit: 100
  unit: minute # Options: second, minute, hour, day
  burstSize: 20
```

### CORS Configuration

```yaml
cors:
  enabled: true
  allowOrigins:
    - "https://example.com"
  allowMethods:
    - GET
    - POST
  allowHeaders:
    - Authorization
    - Content-Type
```

### Complete Example

```yaml
apiVersion: openchoreo.dev/v1alpha1
kind: Component
metadata:
  name: my-api-service
spec:
  type: deployment/service
  workload:
    name: my-api-workload
  traits:
    - name: api-management
      properties:
        authentication:
          type: oauth2
          oauth2:
            required: true
            scopes:
              - read:api
              - write:api
        rateLimit:
          requestsPerUnit: 1000
          unit: hour
          burstSize: 50
        cors:
          enabled: true
          allowOrigins:
            - "*"
          allowMethods:
            - GET
            - POST
            - PUT
            - DELETE
          allowHeaders:
            - Authorization
            - Content-Type
```

## Troubleshooting

### API Platform Pods Not Running

Check pod status and logs:

```bash
kubectl get pods -n openchoreo-control-plane -l app.kubernetes.io/component=api-platform
kubectl logs -n openchoreo-control-plane -l app.kubernetes.io/name=api-platform-gateway
```

### Token Validation Failures

Verify Thunder IDP is accessible:

```bash
kubectl get svc -n openchoreo-control-plane thunder-idp
kubectl logs -n openchoreo-control-plane -l app.kubernetes.io/name=thunder-idp
```

### API Still Accessible Without Token

Check that the component has the API Management trait applied:

```bash
kubectl get component greeter-service -o jsonpath='{.spec.traits}'
```

Verify the release has been updated:

```bash
kubectl describe releasebinding greeter-service-development
```

### Rate Limit Not Working

Check the API Platform enforcer logs:

```bash
kubectl logs -n openchoreo-control-plane -l app.kubernetes.io/name=api-platform-enforcer
```

## Production Considerations

### External Identity Provider

For production environments, configure an external OAuth2 provider instead of Thunder IDP:

```yaml
api-platform:
  enabled: true
  identityProvider:
    type: external
    oauth2:
      issuerUrl: https://auth.example.com
      jwksUrl: https://auth.example.com/.well-known/jwks.json
```

### TLS/HTTPS

Enable TLS for API endpoints:

```yaml
api-platform:
  enabled: true
  gateway:
    tls:
      enabled: true
      certificateRef:
        name: api-gateway-cert
        namespace: openchoreo-control-plane
```

### Monitoring and Analytics

Enable API analytics and monitoring:

```yaml
api-platform:
  enabled: true
  analytics:
    enabled: true
    backend: prometheus
```

View API metrics:

```bash
kubectl port-forward -n openchoreo-control-plane svc/prometheus 9090:9090
```

Open http://localhost:9090 and query metrics like:

- `api_requests_total`
- `api_request_duration_seconds`
- `api_rate_limit_exceeded_total`

## Summary

You've successfully:

- Enabled the API Platform module in OpenChoreo
- Deployed a sample service with API Management
- Secured your API with OAuth2 authentication
- Tested token-based access control
- Explored advanced API Management configurations

Your APIs are now protected with enterprise-grade security, rate limiting, and access controlâ€”all managed declaratively through OpenChoreo!

## Next Steps

- [Configure custom OAuth2 providers](./identity-provider/oauth2-configuration.mdx)
- [Set up API analytics and monitoring](./observability-alerting.mdx)
- [Implement advanced rate limiting strategies](../reference/api/platform/trait.md)
- [Deploy multiple environments with different API policies](../concepts/runtime-model.md)

## Clean Up

To disable API Management for a component, remove the trait:

```bash
kubectl patch component greeter-service --type=json \
  -p='[{"op": "remove", "path": "/spec/traits"}]'
```

To uninstall the API Platform module:

<CodeBlock language="bash">
  {`helm upgrade openchoreo-control-plane ${versions.helmSource}/openchoreo-control-plane \\
  --version ${versions.helmChart} \\
  --namespace openchoreo-control-plane \\
  --reuse-values \\
  --set api-platform.enabled=false`}
</CodeBlock>
